var Suggest=function(domSuggestField,jContainer){function getIdentKey(){var sIdentKey=jQuery.cookie('AuctionBG_SuggestIdentKey');if(sIdentKey!==null)return sIdentKey;sIdentKey=generateIdentKey();var nCookieExpireDays=round(((COOKIE_EXPIRE_TIME/24)/60));jQuery.cookie('AuctionBG_SuggestIdentKey',sIdentKey,{expires:nCookieExpireDays,path:'/'});return sIdentKey;}
function generateIdentKey(){var S4=function(){return Math.floor(Math.random()*0x10000).toString(16);}
return SparkMD5.hash(S4()+S4()+'-'+S4()+'-'+S4()+'-'+S4()+'-'+S4()+S4()+S4());}
function loadSuggestData(oSelf,domSuggestField){setTimeout(function(){var sRequestKeyWords=trim(jQuery(domSuggestField).val());if(sRequestKeyWords.length<2){domSuggestField.old_value=sRequestKeyWords;return refreshSuggestData(oSelf,sRequestKeyWords,null);}
if(domSuggestField.old_value===sRequestKeyWords)return null;domSuggestField.old_value=sRequestKeyWords;var oSuggestData=Storage.loadData(sRequestKeyWords);refreshSuggestData(oSelf,sRequestKeyWords,oSuggestData);if(oSuggestData!==null)return false;jQuery.post(BASE_URL+'/ajax/suggest.ajax.php',{key_words:sRequestKeyWords,suggest_key:oSelf.sIdentKey},function(result){Storage.saveData(result.keywords,result.result);if(result.keywords!==trim(jQuery(domSuggestField).val()))return null;return refreshSuggestData(oSelf,result.keywords,Storage.loadData(sRequestKeyWords));},'json');},250);}
function refreshSuggestData(oSelf,sKeyWords,oData){changeSuggestFormVsisibility(false,oSelf);if(count(oData)<=0)return false;oSelf.jSuggestResultContainer.empty();oSelf.jSuggestResultContainer.append('<li class="default_word hover">'+sKeyWords+'</li>');for(var key in oData){oSelf.jSuggestResultContainer.append('<li>'+oData[key].replace(new RegExp(sKeyWords,'gi'),'<b>'+sKeyWords+'</b>')+'</li>');}
changeSuggestFormVsisibility(true,oSelf);return true;}
function changeSuggestFormVsisibility(bIsVisible,oSelf){if(bIsVisible===false){oSelf.jSuggestResultContainer.empty();oSelf.jSuggestResultContainer.removeClass('visible');oSelf.jSuggestField.removeClass('suggest_showed');}else{oSelf.jSuggestResultContainer.addClass('visible');oSelf.jSuggestField.addClass('suggest_showed');jQuery('body').bind('click.hideSuggestResult',function(event){changeSuggestFormVsisibility(false,oSelf);jQuery('body').unbind('click.hideSuggestResult');});jQuery(oSelf.jSuggestResultContainer.find('li')).click(function(event){oSelf.jSuggestField.val(jQuery(this).text());oSelf.jSearchForm.submit();}).mouseover(function(event){jQuery(this).addClass('hover');}).mouseout(function(event){jQuery(this).removeClass('hover');});}}
var Storage={loadData:function(sKeyWords){sKeyWords=escape(sKeyWords);var sStorageKey='suggest['+sKeyWords+']',oData=sessionStorage.getItem(sStorageKey);if(oData===null){oData=localStorage.getItem(sStorageKey);if(oData===null)return null;oData=JSON.parse(oData);var nCurrentTimestamp=time();if(oData.expire_time<nCurrentTimestamp){localStorage.removeItem(sStorageKey);return null;}
return oData.data;}else return JSON.parse(oData);},saveData:function(sKeyWords,oData){if(count(oData)<=0){if(SUGGEST_AUTO_UPDATE)return false;else oData={};}
var sStorageKey='suggest['+escape(sKeyWords)+']';sessionStorage.setItem(sStorageKey,JSON.stringify(oData));var nExpireTime=round(strtotime('+'+LOCALSTORAGE_EXPIRE_TIME+' MINUTES'));localStorage.setItem(sStorageKey,JSON.stringify({expire_time:nExpireTime,data:oData}));return true;}}
try{var jSuggestField=jQuery(domSuggestField);if(jSuggestField.is('input[type=text][suggest]')!==true)throw'Invalid Suggest Field';this.jSuggestField=jSuggestField;var jSearchForm=this.jSuggestField.parents('form');if(jSearchForm.is('form')!==true)throw'Invalid Search Form';this.jSearchForm=jSearchForm;this.sIdentKey=getIdentKey();this.jIdentKeyField=jQuery('<input type="hidden" name="ident_key" value="'+this.sIdentKey+'" />');this.jSearchForm.append(this.jIdentKeyField);this.jSuggestContainer=jQuery('<div class="suggest_container"></div>');this.jSuggestField.after(this.jSuggestContainer);this.jSuggestField.appendTo(this.jSuggestContainer);this.jSuggestResultContainer=jQuery('<ul class="suggest_result"></ul>');this.jSuggestContainer.append(this.jSuggestResultContainer);var oSelf=this;this.jSuggestField.keyup(function(event){if(in_array(event.keyCode,[38,40]))return null;if(event.keyCode===13)return changeSuggestFormVsisibility(false,oSelf);if(event.keyCode===27){var sDefaultKeyWords=jQuery(oSelf.jSuggestContainer.find('li.default_word')[0]).text();if(sDefaultKeyWords.length>0)oSelf.jSuggestField.val(sDefaultKeyWords);return changeSuggestFormVsisibility(false,oSelf);}
loadSuggestData(oSelf,this);}).keydown(function(event){if(!in_array(event.keyCode,[38,40]))return null;var jSuggestRows=jQuery(oSelf.jSuggestResultContainer.find('li')),nSuggestRowsCount=jSuggestRows.length;if(nSuggestRowsCount<=0)return null;var newHoverElement=(event.keyCode==40?jSuggestRows.filter('.hover').next()[0]:jSuggestRows.filter('.hover').prev()[0]);if(typeof(newHoverElement)==='undefined'){newHoverElement=(event.keyCode==40?newHoverElement=jSuggestRows[0]:newHoverElement=jSuggestRows[nSuggestRowsCount-1]);}
jQuery(this).val(jQuery(newHoverElement).text());jSuggestRows.removeClass('hover');jQuery(newHoverElement).addClass('hover');event.preventDefault();});this.hideSuggestResult=function(){changeSuggestFormVsisibility(false,oSelf);}
jContainer.css({opacity:0,visibility:'visible'}).animate({opacity:1},500,function(){jContainer.find('div.shadow').css({opacity:0,visibility:'visible'}).animate({opacity:1},1000);});}catch(sErrorMessage){console.log('Suggest Error: '+sErrorMessage);}}